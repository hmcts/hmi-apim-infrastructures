<fragment>
    <send-request ignore-error="false" timeout="20" response-variable-name="snlClientResponse" mode="new">
        <set-url>https://#keyVaultHost#/secrets/snl-client-id/?api-version=7.0</set-url>
        <set-method>GET</set-method>
        <authentication-managed-identity resource="https://vault.azure.net" />
    </send-request>
    <send-request ignore-error="false" timeout="20" response-variable-name="snlSecretResponse" mode="new">
        <set-url>https://#keyVaultHost#/secrets/snl-client-pwd/?api-version=7.0</set-url>
        <set-method>GET</set-method>
        <authentication-managed-identity resource="https://vault.azure.net" />
    </send-request>
    <send-request ignore-error="true" timeout="20" response-variable-name="snlBearerToken" mode="new">
        <set-url>#sAndLOauthUrl#</set-url>
        <set-method>POST</set-method>
        <set-header name="Content-Type" exists-action="override">
            <value>application/x-www-form-urlencoded</value>
        </set-header>
        <set-body>@{
            return "username=" + (string)context.Variables["snlClient"] + "&password=" + (string)context.Variables["snlSecret"] + "&grant_type=password_credentials";}</set-body>
    </send-request>
    <set-header name="Authorization" exists-action="override">
        <value>@("Bearer " + (String)((IResponse)context.Variables["snlBearerToken"]).Body.As<JObject>()["idToken"])</value>
    </set-header>
    <cache-store-value key="snlAuth" value="@(context.Request.Headers.GetValueOrDefault("Authorization", ""))" duration="2700" />
</fragment>